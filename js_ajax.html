<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab4 젤리 재고 관리 시스템</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
        }

        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
        }

        /* 입력 폼 스타일 */
        #inputForm {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px 20px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fcfcfc;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        /* 버튼 스타일 */
        #buttonGroup {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        #btnRead {
            background-color: #5cb85c;
            color: white;
        }

        #btnRead:hover {
            background-color: #4cae4c;
        }

        #btnCreate {
            background-color: #007bff;
            color: white;
        }

        #btnCreate:hover {
            background-color: #0056b3;
        }

        #btnUpdate {
            background-color: #ffc107;
            color: #333;
        }

        #btnUpdate:hover {
            background-color: #e0a800;
        }

        #btnDelete {
            background-color: #dc3545;
            color: white;
        }

        #btnDelete:hover {
            background-color: #c82333;
        }

        button:active {
            transform: scale(0.98);
        }

        /* 젤리 리스트 스타일 */
        #userList {
            list-style: none;
            padding: 0;
        }

        .user-item {
            background: #fcfdff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .user-item:hover {
            background-color: #eaf1fb;
        }

        .item-details strong {
            color: #1a73e8;
            font-size: 1.1rem;
        }

        .item-id {
            font-size: 0.8rem;
            color: #999;
            background-color: #eee;
            padding: 4px 8px;
            border-radius: 4px;
        }

        #inputTargetId {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
        }

        /* 섹션 구분 */
        .section-header {
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ddd;
            color: #555;
            font-size: 1.2rem;
            font-weight: 600;
        }
    </style>
</head>


<body>
    <div class="container">
        <h1>젤리 재고 관리 시스템</h1>

        <h2 class="section-header">재고 현황</h2>
        <div id="readSection">
            <button id="btnRead">재고 전체 조회 (GET)</button>
            <ul id="userList">
                <li></li>
            </ul>
        </div>

        <h2 class="section-header">CRUD</h2>

        <div id="inputForm">
            <div class="input-group">
                <label for="inputName">이름 *</label>
                <input type="text" id="inputName" placeholder="예: 하리보 골드베렌" required>
            </div>
            <div class="input-group">
                <label for="inputPrice">가격 *</label>
                <input type="number" id="inputPrice" placeholder="예: 2.50" required min="0" step="0.01">
            </div>
            <div class="input-group">
                <label for="inputCountry">국가</label>
                <input type="text" id="inputCountry" placeholder="예: 독일">
            </div>
            <div class="input-group">
                <label for="inputQuantity">수량 *</label>
                <input type="number" id="inputQuantity" placeholder="예: 150" required min="0">
            </div>

            <div class="input-group" style="grid-column: 1 / -1;">
                <label for="inputTargetId">ID 지정 (추가 및 수정 시 사용) *</label>
                <input type="text" id="inputTargetId" placeholder="(추가/수정 시 사용할 ID 입력)"
                    title="추가 또는 수정 기능을 사용할 때 ID를 입력.">
            </div>
        </div>

        <div id="buttonGroup">
            <button id="btnCreate">추가 (POST)</button>
            <button id="btnUpdate">수정 (PUT)</button>
            <button id="btnDelete">삭제 (이름으로)</button>
        </div>
    </div>


    <script>
        const API_URL = "http://172.17.172.233:3001/jelly";

        const getInputValues = () => ({
            name: document.getElementById('inputName').value.trim(),
            price: parseFloat(document.getElementById('inputPrice').value),
            country: document.getElementById('inputCountry').value.trim(),
            quantity: parseInt(document.getElementById('inputQuantity').value, 10),
            targetId: document.getElementById('inputTargetId').value.trim() // ID를 targetId로 사용
        });

        const clearInputs = () => {
            document.getElementById('inputName').value = '';
            document.getElementById('inputPrice').value = '';
            document.getElementById('inputCountry').value = '';
            document.getElementById('inputQuantity').value = '';
            document.getElementById('inputTargetId').value = '';
        };

        const updateUI = (data) => {
            const userList = document.getElementById("userList");
            userList.innerHTML = Array.isArray(data) && data.length > 0
                ? data.map(candy =>
                    `<li class="user-item">
                        <span class="item-details">
                            <strong>${candy.name}</strong> (${candy.country}) | $${candy.price.toFixed(2)} | 재고: <strong>${candy.quantity}</strong>개
                        </span>
                        <span class="item-id">ID: ${candy.id}</span>
                    </li>`
                ).join('')
                : '<li>표시할 데이터가 없습니다. (서버 연결을 확인하세요)</li>';
        };

        const handleFetch = async (url, options = {}) => {
            try {
                const response = await fetch(url, options);

                if (!response.ok) {
                    let errorText = await response.text();
                    try {

                        const errorJson = JSON.parse(errorText);
                        errorText = errorJson.id || errorText;
                    } catch (e) {
                    }
                    throw new Error(`HTTP 오류: ${response.status} - ${response.statusText} (${errorText})`);
                }

                return response.status !== 204 ? await response.json() : null;
            } catch (error) {
                console.error("AJAX 요청 실패:", error);
                throw error;
            }
        };

        // Read (조회) - GET
        const readData = async () => {
            try {
                const data = await handleFetch(API_URL);
                updateUI(data);
                return data;
            } catch (error) {
                alert("데이터 조회에 실패했습니다. 서버(json-server) 실행 여부와 콘솔을 확인하세요.");
                return null;
            }
        };

        // Create (추가) - POST
        const createData = async () => {
            const { name, price, country, quantity, targetId } = getInputValues();

            // 필수 입력값 및 ID 확인
            if (!name || isNaN(price) || price < 0 || isNaN(quantity) || quantity < 0) {
                alert("이름, 가격, 수량을 올바르게 입력해주세요.");
                return;
            }
            if (!targetId) {
                alert("추가할 젤리의 ID를 'ID 지정' 필드에 반드시 입력해주세요.");
                return;
            }

            // ID를 포함한 새 데이터 객체
            const newCandyData = { id: targetId, name, price, country, quantity };

            try {
                const options = {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newCandyData)
                };
                const result = await handleFetch(API_URL, options);
                alert(`데이터 추가 완료: ${result.name} (ID: ${result.id})`);
                clearInputs();
                await readData();
            } catch (error) {
                alert(`데이터 추가에 실패했습니다. (ID 중복 또는 서버 오류). 콘솔을 확인하세요. 오류: ${error.message}`);
            }
        };

        // Update (수정) - PUT
        const updateData = async () => {
            const { name, price, country, quantity, targetId } = getInputValues();

            if (!targetId) {
                alert("수정할 대상의 ID를 'ID 지정' 필드에 반드시 입력해주세요.");
                return;
            }
            if (!name || isNaN(price) || price < 0 || isNaN(quantity) || quantity < 0) {
                alert("수정할 이름, 가격, 수량을 올바르게 입력해주세요.");
                return;
            }

            try {
                const updateUrl = `${API_URL}/${targetId}`;
                const updatedPayload = { name, price, country, quantity, id: targetId };

                const options = {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedPayload)
                };
                await handleFetch(updateUrl, options);
                alert(`ID ${targetId} 데이터 수정 완료.`);
                clearInputs();
                await readData();
            } catch (error) {
                alert(`데이터 수정에 실패했습니다. (ID 오류 또는 서버 오류). 콘솔을 확인하세요. 오류: ${error.message}`);
            }
        };

        // Delete (삭제) - DELETE
        const deleteData = async () => {
            const currentData = await readData();
            if (!currentData) return;

            const candyName = prompt("삭제할 젤리의 정확한 이름을 입력하세요.");
            if (!candyName) return;

            try {
                const targetCandy = currentData.find(candy => candy.name.toLowerCase() === candyName.toLowerCase());

                if (!targetCandy) {
                    alert(`오류: "${candyName}" 이름의 젤리를 찾을 수 없습니다. (정확한 이름을 다시 확인하세요)`);
                    return;
                }
                const targetId = targetCandy.id;
                if (!confirm(`정말로 젤리 "${targetCandy.name}" (ID: ${targetId})을 삭제하시겠습니까?`)) {
                    return;
                }
                const deleteUrl = `${API_URL}/${targetId}`;
                await handleFetch(deleteUrl, { method: "DELETE" });
                alert(`젤리 "${targetCandy.name}" 데이터 삭제 완료.`);
                await readData();
            } catch (error) {
                alert(`데이터 삭제에 실패했습니다. 콘솔을 확인하세요. 오류: ${error.message}`);
            }
        };
        document.getElementById("btnRead").addEventListener("click", readData);
        document.getElementById("btnCreate").addEventListener("click", createData);
        document.getElementById("btnUpdate").addEventListener("click", updateData);
        document.getElementById("btnDelete").addEventListener("click", deleteData);
    </script>
</body>

</html>